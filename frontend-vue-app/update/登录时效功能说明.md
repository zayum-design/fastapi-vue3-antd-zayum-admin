# 登录时效功能说明

## 功能概述

本功能实现了登录时效控制，用户登录后会在指定时间后自动退出登录。登录过期时间可在环境变量中配置。

## 实现文件

1. **环境配置** - `frontend-vue-app/.env.development`
   - 添加了 `VITE_LOGIN_EXPIRY_HOURS=2` 配置项

2. **访问存储** - `frontend-vue-app/src/stores/modules/admin-access.ts`
   - 添加了登录时间记录和过期检查功能
   - 实现了定时器自动过期检查
   - 添加了初始化方法

3. **认证存储** - `frontend-vue-app/src/store/admin/auth.ts`
   - 登录成功时设置登录时间
   - 登出时清除过期检查定时器

4. **路由守卫** - `frontend-vue-app/src/router/guard/admin.ts`
   - 添加登录过期检查
   - 过期时自动跳转到登录页
   - 初始化过期检查定时器

## 功能特性

### 1. 登录时间记录
- 用户登录成功时记录当前时间戳
- 登录时间会被持久化存储，页面刷新后仍然有效

### 2. 自动过期检查
- 设置定时器在指定时间后自动触发过期
- 定时器会在页面刷新后重新启动

### 3. 路由守卫检查
- 每次路由切换时检查登录是否过期
- 过期时自动执行登出操作并跳转到登录页

### 4. 配置灵活
- 过期时间通过环境变量 `VITE_LOGIN_EXPIRY_HOURS` 配置
- 默认值为 2 小时

## 配置方法

### 开发环境
在 `frontend-vue-app/.env.development` 中配置：
```
VITE_LOGIN_EXPIRY_HOURS=2
```

### 生产环境
在 `frontend-vue-app/.env.production` 中配置：
```
VITE_LOGIN_EXPIRY_HOURS=2
```

### 自定义过期时间
将数字改为所需的小时数，例如：
- 1小时：`VITE_LOGIN_EXPIRY_HOURS=1`
- 4小时：`VITE_LOGIN_EXPIRY_HOURS=4`
- 30分钟：`VITE_LOGIN_EXPIRY_HOURS=0.5`

## 技术实现细节

### 过期检查逻辑
```typescript
checkLoginExpiry(): boolean {
  if (!this.loginTime) return false;
  
  const expiryHours = import.meta.env.VITE_LOGIN_EXPIRY_HOURS || 2;
  const expiryMs = expiryHours * 60 * 60 * 1000;
  const currentTime = Date.now();
  const timeDiff = currentTime - this.loginTime;
  
  return timeDiff >= expiryMs;
}
```

### 定时器设置
```typescript
startExpiryCheck() {
  if (this.expiryTimer) {
    clearTimeout(this.expiryTimer);
  }
  
  const expiryHours = import.meta.env.VITE_LOGIN_EXPIRY_HOURS || 2;
  const expiryMs = expiryHours * 60 * 60 * 1000;
  
  this.expiryTimer = window.setTimeout(() => {
    console.log('登录已过期，自动退出登录');
    this.setLoginExpired(true);
    this.triggerAutoLogout();
  }, expiryMs);
}
```

## 测试验证

运行测试脚本验证功能：
```bash
cd frontend-vue-app
node test-login-expiry.js
```

## 注意事项

1. **时间精度**：使用 JavaScript 的 `Date.now()` 获取毫秒级时间戳
2. **持久化存储**：登录时间会被持久化到 localStorage
3. **定时器管理**：页面刷新后定时器会重新启动
4. **循环依赖**：避免存储之间的循环依赖，通过状态触发登出

## 扩展建议

1. **用户提示**：可以在过期前几分钟显示提示信息
2. **自动续期**：用户活动时可以自动续期登录时间
3. **多环境配置**：为不同环境设置不同的过期时间
