# sys_analytics_metrics 单表设计

```sql
CREATE TABLE sys_analytics_metrics (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'Primary key ID',
  record_date DATE NOT NULL COMMENT 'Record date (YYYY-MM-DD)',
  
  -- User metrics
  user_count BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'Daily active users',
  total_users BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'Cumulative total users',
  
  -- Visit metrics
  visit_count BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'Daily visits',
  total_visits BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'Cumulative total visits',
  
  -- Download metrics
  download_count BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'Daily downloads',
  total_downloads BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'Cumulative total downloads',
  
  -- Usage metrics
  usage_count BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'Daily active usage sessions',
  total_usage BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'Cumulative total usage sessions',
  
  -- Dimensions
  source ENUM('web', 'app', 'mobile_web', 'api', 'other') 
    DEFAULT NULL COMMENT 'Traffic source (web, mobile app, etc)',
  
  device_type ENUM('mobile', 'desktop', 'tablet', 'smart_tv', 'other') 
    DEFAULT NULL COMMENT 'User device type',
  
  region VARCHAR(50) DEFAULT NULL COMMENT 'Geographical region/country',
  
  -- Timestamps
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP 
    COMMENT 'Record creation timestamp',
    
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP 
    COMMENT 'Record last update timestamp',
  
  -- Indexes
  PRIMARY KEY (id),
  UNIQUE KEY idx_date_dimensions (record_date, source, device_type, region),
  KEY idx_date (record_date),
  KEY idx_region (region),
  KEY idx_source (source),
  KEY idx_device (device_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Unified analytics metrics table';
```

## 关键设计说明

- **指标设计 (Metrics Design)**
  - 每日值 vs 累计值：每组指标包含两个字段
    - `*_count`：当日新增值（如 daily active users）
    - `total_*`：历史累计值（如 cumulative total users）
  - 指标分组：
    - User metrics：用户相关指标
    - Visit metrics：访问相关指标
    - Download metrics：下载相关指标
    - Usage metrics：使用行为指标

- **维度设计 (Dimension Design)**
  - `source`：流量来源（使用 ENUM 确保数据一致性）
  - `device_type`：设备类型（使用 ENUM 确保数据一致性）
  - `region`：地理区域（使用 VARCHAR 保持灵活性）

- **索引优化 (Index Optimization)**
  - 唯一索引：idx_date_dimensions 确保每天每个维度的唯一记录
  - 日期索引：idx_date 优化时间范围查询
  - 维度索引：idx_region, idx_source, idx_device 优化分组查询

- **数据类型选择 (Data Type Selection)**
  - BIGINT UNSIGNED：所有指标值使用无符号大整数，支持大数值
  - DATE：日期字段使用 DATE 类型而非 DATETIME
  - TIMESTAMP：自动管理时间戳字段

## 示例查询

### 1. 获取最近7天核心指标

```sql
SELECT 
  record_date AS 'Date',
  user_count AS 'Daily Users',
  visit_count AS 'Daily Visits',
  download_count AS 'Daily Downloads',
  usage_count AS 'Daily Usage'
FROM sys_analytics_metrics
WHERE record_date BETWEEN CURDATE() - INTERVAL 7 DAY AND CURDATE()
ORDER BY record_date;
```

### 2. 按设备类型统计用户量

```sql
SELECT 
  device_type AS 'Device',
  SUM(user_count) AS 'Total Users'
FROM sys_analytics_metrics
WHERE record_date >= '2023-01-01'
GROUP BY device_type
ORDER BY SUM(user_count) DESC;
```

### 3. 获取各区域最新总指标

```sql
SELECT 
  region AS 'Region',
  MAX(total_users) AS 'Total Users',
  MAX(total_visits) AS 'Total Visits',
  MAX(total_downloads) AS 'Total Downloads',
  MAX(total_usage) AS 'Total Usage'
FROM sys_analytics_metrics
GROUP BY region
ORDER BY MAX(total_users) DESC;
```

## 分区建议 (Partitioning Recommendation)

对于大型数据集（>1000万行），添加按月分区：

```sql
ALTER TABLE sys_analytics_metrics 
PARTITION BY RANGE COLUMNS(record_date) (
    PARTITION p2023_01 VALUES LESS THAN ('2023-02-01'),
    PARTITION p2023_02 VALUES LESS THAN ('2023-03-01'),
    PARTITION p2023_03 VALUES LESS THAN ('2023-04-01'),
    PARTITION p_current VALUES LESS THAN (MAXVALUE)
);
```




```sql
-- 禁用外键检查以加快插入速度
SET FOREIGN_KEY_CHECKS = 0;
SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='TRADITIONAL';

-- 为2025年5月1日至2025年5月30日生成随机数据
INSERT INTO `sys_analytics_metrics` (
  `record_date`, `user_count`, `total_users`, `visit_count`, `total_visits`, 
  `download_count`, `total_downloads`, `usage_count`, `total_usage`, 
  `source`, `device_type`, `region`
)
WITH RECURSIVE dates AS (
  SELECT CAST('2025-05-01' AS DATE) AS date
  UNION ALL
  SELECT date + INTERVAL 1 DAY FROM dates WHERE date < '2025-05-30'
),
sources AS (
  SELECT 'web' AS source UNION ALL SELECT 'app' UNION ALL 
  SELECT 'mobile_web' UNION ALL SELECT 'api' UNION ALL SELECT 'other'
),
devices AS (
  SELECT 'mobile' AS device UNION ALL SELECT 'desktop' UNION ALL 
  SELECT 'tablet' UNION ALL SELECT 'smart_tv' UNION ALL SELECT 'other'
),
regions AS (
  SELECT 'US' AS region UNION ALL SELECT 'UK' UNION ALL SELECT 'DE' UNION ALL 
  SELECT 'FR' UNION ALL SELECT 'JP' UNION ALL SELECT 'CN' UNION ALL 
  SELECT 'IN' UNION ALL SELECT 'BR' UNION ALL SELECT 'CA' UNION ALL 
  SELECT 'AU' UNION ALL SELECT NULL
),
daily_combinations AS (
  SELECT 
    d.date,
    s.source,
    dv.device,
    r.region,
    -- 生成随机指标 (基础值 + 随机波动)
    FLOOR(1000 + RAND() * 9000) AS base_users,
    FLOOR(5000 + RAND() * 45000) AS base_visits,
    FLOOR(100 + RAND() * 900) AS base_downloads,
    FLOOR(2000 + RAND() * 8000) AS base_usage
  FROM dates d
  CROSS JOIN sources s
  CROSS JOIN devices dv
  CROSS JOIN regions r
  WHERE RAND() < 0.7 -- 只保留70%的组合，使数据更真实
)
SELECT 
  date AS record_date,
  -- 用户指标
  base_users AS user_count,
  @total_users := IFNULL(@total_users, 0) + base_users AS total_users,
  -- 访问指标
  base_visits AS visit_count,
  @total_visits := IFNULL(@total_visits, 0) + base_visits AS total_visits,
  -- 下载指标
  base_downloads AS download_count,
  @total_downloads := IFNULL(@total_downloads, 0) + base_downloads AS total_downloads,
  -- 使用指标
  base_usage AS usage_count,
  @total_usage := IFNULL(@total_usage, 0) + base_usage AS total_usage,
  -- 维度
  source,
  device_type,
  region
FROM daily_combinations, (SELECT @total_users := 0, @total_visits := 0, @total_downloads := 0, @total_usage := 0) AS vars
ORDER BY date, source, device_type, region;

-- 重置变量和模式
SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;
SET FOREIGN_KEY_CHECKS = 1;






-- Disable foreign key checks for faster insertion
SET FOREIGN_KEY_CHECKS = 0;

-- Insert random data for each day from May 1 to May 30, 2025
INSERT INTO `sys_analytics_metrics` 
(`record_date`, `user_count`, `total_users`, `visit_count`, `total_visits`, 
 `download_count`, `total_downloads`, `usage_count`, `total_usage`, 
 `source`, `device_type`, `region`)
WITH RECURSIVE dates AS (
    SELECT CAST('2025-05-01' AS DATE) AS date
    UNION ALL
    SELECT date + INTERVAL 1 DAY FROM dates WHERE date < '2025-05-30'
),
dimensions AS (
    SELECT 'web' AS source, 'desktop' AS device_type, 'US' AS region UNION ALL
    SELECT 'web', 'desktop', 'EU' UNION ALL
    SELECT 'web', 'mobile', 'US' UNION ALL
    SELECT 'web', 'mobile', 'EU' UNION ALL
    SELECT 'app', 'mobile', 'US' UNION ALL
    SELECT 'app', 'mobile', 'EU' UNION ALL
    SELECT 'app', 'tablet', 'US' UNION ALL
    SELECT 'app', 'tablet', 'EU' UNION ALL
    SELECT 'mobile_web', 'mobile', 'US' UNION ALL
    SELECT 'mobile_web', 'mobile', 'EU' UNION ALL
    SELECT 'api', 'other', 'US' UNION ALL
    SELECT 'api', 'other', 'EU' UNION ALL
    SELECT 'other', 'other', 'US' UNION ALL
    SELECT 'other', 'other', 'EU'
)
SELECT 
    d.date AS record_date,
    FLOOR(RAND() * 5000) + 1000 AS user_count,
    FLOOR(RAND() * 100000) + 50000 AS total_users,
    FLOOR(RAND() * 20000) + 5000 AS visit_count,
    FLOOR(RAND() * 500000) + 200000 AS total_visits,
    FLOOR(RAND() * 3000) + 500 AS download_count,
    FLOOR(RAND() * 100000) + 50000 AS total_downloads,
    FLOOR(RAND() * 10000) + 2000 AS usage_count,
    FLOOR(RAND() * 300000) + 100000 AS total_usage,
    dim.source,
    dim.device_type,
    dim.region
FROM dates d
CROSS JOIN dimensions dim
ORDER BY d.date, dim.source, dim.device_type, dim.region;

-- Enable foreign key checks back
SET FOREIGN_KEY_CHECKS = 1;

```